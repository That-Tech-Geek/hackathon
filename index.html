<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Agent (ONNX Powered)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ONNX Runtime Web (Inference Engine) -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

    <!-- PyScript (ETL Engine) -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.10.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.10.1/core.js"></script>

    <style>
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <!-- CONFIGURATION: Minimal Dependencies -->
    <py-config>
        packages = ["numpy<2.0.0", "pandas", "openpyxl"]
    </py-config>

    <!-- UI LAYER -->
    <div class="max-w-4xl w-full space-y-8 animate-fade-in">
        <div class="text-center">
            <h1 class="text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                Clinical Agent <span class="text-white text-2xl font-light">ONNX</span>
            </h1>
            <p class="mt-3 text-slate-400 text-lg">WASM-Accelerated Inference Engine</p>
        </div>

        <!-- STATUS BOX -->
        <div id="status-box" class="bg-slate-800/50 backdrop-blur p-4 rounded-lg border border-slate-700 text-center transition-all duration-300">
            <div id="loading-spinner" class="inline-block w-4 h-4 border-2 border-pink-400 border-t-transparent rounded-full animate-spin mr-2"></div>
            <span id="loading-text" class="text-pink-400 font-mono text-sm">Initializing ONNX Runtime & Python ETL...</span>
        </div>

        <!-- UPLOAD SECTION -->
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-700 shadow-2xl relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-purple-500 group-hover:bg-purple-400 transition-colors"></div>
            
            <label class="block mb-4 text-sm font-medium text-slate-300 uppercase tracking-wider">Upload Clinical Dataset (.xlsx)</label>
            <input type="file" id="file-upload" class="block w-full text-sm text-slate-400 
                file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 
                file:text-sm file:font-semibold file:bg-purple-600 file:text-white 
                hover:file:bg-purple-500 file:cursor-pointer cursor-pointer transition-all" 
                accept=".xlsx" disabled>
            
            <button id="analyze-btn" class="mt-8 w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg opacity-50 cursor-not-allowed transform active:scale-95" disabled onclick="handleAnalysis()">
                INITIATE ONNX INFERENCE
            </button>
        </div>

        <!-- RESULTS DASHBOARD -->
        <div id="results-area" class="hidden space-y-6 transition-all duration-500 ease-in-out">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-blue-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Operational</h3>
                    <p id="res-num" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">Cycle time & variance metrics</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-purple-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Documentation</h3>
                    <p id="res-alpha" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">NLP semantic analysis</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-orange-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Integrity</h3>
                    <p id="res-alphanum" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">Pattern matching & complexity</p>
                </div>
            </div>
            
            <div class="bg-slate-900 border border-slate-700 rounded-lg shadow-xl overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-pink-400">Intervention Protocol</h3>
                </div>
                <div class="p-6">
                    <pre id="intervention-text" class="text-sm text-slate-300 font-mono whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LAYER -->
    <script>
        // Global Session Store
        const SESSIONS = {
            numeric: null,
            alphabet: null,
            alphanum: null
        };

        // 1. Load ONNX Models
        async function initModels() {
            const status = document.getElementById('loading-text');
            try {
                // Ensure the user has these files in the same directory!
                const options = { executionProviders: ['wasm'] };
                
                status.innerText = "Loading ONNX Models...";
                
                // Helper to load or warn
                const load = async (path) => {
                    try {
                        return await ort.InferenceSession.create(path, options);
                    } catch (e) {
                        console.warn(`Could not load ${path}. Ensure file exists. Using Fallback.`);
                        return null;
                    }
                };

                SESSIONS.numeric = await load('./numeric.onnx');
                SESSIONS.alphabet = await load('./alphabet.onnx');
                SESSIONS.alphanum = await load('./alphanum.onnx');

                status.innerText = "System Ready. Hybrid Architecture Online.";
                status.className = "text-emerald-400 font-mono font-bold";
                document.getElementById('loading-spinner').className = "inline-block w-4 h-4 rounded-full bg-emerald-400 mr-2";
                
                document.getElementById('file-upload').disabled = false;
                const btn = document.getElementById('analyze-btn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');

            } catch (e) {
                console.error(e);
                status.innerText = "Initialization Failed: " + e.message;
            }
        }

        // 2. Main Analysis Trigger
        async function handleAnalysis() {
            const btn = document.getElementById('analyze-btn');
            const fileInput = document.getElementById('file-upload');
            
            if (fileInput.files.length === 0) {
                alert("Please select a file first.");
                return;
            }

            btn.innerText = "EXTRACTING FEATURES (PYTHON ETL)...";
            btn.disabled = true;

            try {
                // A. Get File Bytes
                const file = fileInput.files[0];
                const arrayBuffer = await file.arrayBuffer();
                const bytes = new Uint8Array(arrayBuffer);

                // B. Call PyScript
                if (!window.process_excel_bridge) throw new Error("Python Runtime not ready.");
                const features = await window.process_excel_bridge(bytes); 
                
                if (features.error) throw new Error(features.error);

                btn.innerText = "RUNNING INFERENCE (ONNX)...";

                // C. Run Inference
                const results = await runOnnxInference(features);

                // D. Display
                displayResults(results);

                btn.innerText = "RUN ANALYSIS AGAIN";
                btn.disabled = false;

            } catch (e) {
                console.error(e);
                alert("Analysis Error: " + e.message);
                btn.innerText = "INITIATE ONNX INFERENCE";
                btn.disabled = false;
            }
        }

        async function runOnnxInference(data) {
            // Setup results array matching site_ids
            let scores = data.site_ids.map(id => ({ 
                site_id: id, 
                numeric: 0, 
                alphabet: 0, 
                alphanum: 0,
                global: 0 
            }));

            // Inference Helper
            const predict = async (session, inputData, type, shape) => {
                // Fallback for demo if model missing
                if (!session) return new Array(inputData.length).fill(Math.random() * -0.5); 
                
                try {
                    let tensor;
                    if (type === 'string') {
                        // String Tensor (inputData must be flat array of strings)
                        tensor = new ort.Tensor('string', inputData, shape);
                    } else {
                        // Float32 Tensor (Must convert to Float32Array first!)
                        const flatData = inputData.flat();
                        const typedData = new Float32Array(flatData);
                        tensor = new ort.Tensor('float32', typedData, shape);
                    }

                    const feeds = {};
                    feeds[session.inputNames[0]] = tensor;
                    
                    const output = await session.run(feeds);
                    // Standard sklearn-onnx outputs: 'label' and 'probabilities' or 'scores'
                    // We assume outputNames[0] is the decision function/score
                    return output[session.outputNames[0]].data;
                } catch (e) {
                    console.error("Inference failed", e);
                    return new Array(inputData.length).fill(0);
                }
            };

            // 1. Numeric
            if (data.numeric && data.numeric.length > 0) {
                const shape = [data.numeric.length, data.numeric[0].length];
                const preds = await predict(SESSIONS.numeric, data.numeric, 'float32', shape);
                scores.forEach((s, i) => s.numeric = preds[i]);
            }

            // 2. Alphabet (Text)
            if (data.alphabet && data.alphabet.length > 0) {
                const shape = [data.alphabet.length, 1];
                const preds = await predict(SESSIONS.alphabet, data.alphabet, 'string', shape);
                scores.forEach((s, i) => s.alphabet = preds[i]);
            }

            // 3. Alphanumeric
            if (data.alphanum && data.alphanum.length > 0) {
                const shape = [data.alphanum.length, data.alphanum[0].length];
                const preds = await predict(SESSIONS.alphanum, data.alphanum, 'float32', shape);
                scores.forEach((s, i) => s.alphanum = preds[i]);
            }

            // Calc Global
            scores.forEach(s => s.global = (s.numeric + s.alphabet + s.alphanum) / 3);
            return scores;
        }

        function displayResults(scores) {
            scores.sort((a, b) => a.global - b.global); 
            const worst = scores[0];

            document.getElementById('res-num').innerText = worst.numeric.toFixed(4);
            document.getElementById('res-alpha').innerText = worst.alphabet.toFixed(4);
            document.getElementById('res-alphanum').innerText = worst.alphanum.toFixed(4);
            document.getElementById('results-area').classList.remove('hidden');

            let failures = [];
            if (worst.numeric < -0.1) failures.push("NUMERIC");
            if (worst.alphabet < -0.1) failures.push("ALPHABET");
            if (worst.alphanum < -0.1) failures.push("ALPHANUMERIC");
            const diagnosis = failures.length ? failures.join(" & ") : "General Anomaly";

            const email = `TO: Site Coordinator (ID: ${worst.site_id})
SUBJECT: URGENT - Risk Anomaly Detected [${diagnosis}]

System monitoring has flagged Site ${worst.site_id} as a critical bottleneck.
Risk Score: ${worst.global.toFixed(4)}

Recommended Actions:
${failures.includes("NUMERIC") ? "- Audit data entry cycle times.\n" : ""}${failures.includes("ALPHABET") ? "- Review clinical notes for semantic completeness.\n" : ""}${failures.includes("ALPHANUMERIC") ? "- Verify Subject IDs against Reference Dictionary.\n" : ""}
Please acknowledge.`;

            document.getElementById('intervention-text').innerText = email;
        }

        window.addEventListener('load', initModels);
    </script>

    <!-- PYTHON ETL LAYER -->
    <py-script>
        import js
        import pandas as pd
        import numpy as np
        import io
        import warnings
        from pyodide.ffi import create_proxy

        warnings.filterwarnings('ignore')

        def detect_and_route(series):
            clean = series.dropna().astype(str)
            if clean.empty: return 'skip'
            try:
                pd.to_numeric(clean)
                return 'numeric'
            except:
                pass
            if clean.str.match(r'^[a-zA-Z\s\.,]+$').all():
                return 'alphabet'
            return 'alphanumeric'

        def process_excel_py(file_bytes):
            try:
                content = bytes(file_bytes.to_py())
                xls = pd.ExcelFile(io.BytesIO(content))
                
                buffer_num, buffer_alpha, buffer_alphanum = [], [], []
                
                for sheet in xls.sheet_names:
                    if 'ref' in sheet.lower() or 'dict' in sheet.lower(): continue
                    df = pd.read_excel(xls, sheet_name=sheet)
                    if df.empty: continue
                    
                    df.columns = [str(c).lower().strip().replace(' ', '_') for c in df.columns]
                    site_col = next((c for c in df.columns if 'site' in c and 'id' in c), None)
                    if not site_col: continue
                    df.rename(columns={site_col: 'site_id'}, inplace=True)
                    
                    curr_num = pd.DataFrame({'site_id': df['site_id']})
                    curr_alpha = pd.DataFrame({'site_id': df['site_id']})
                    curr_alphanum = pd.DataFrame({'site_id': df['site_id']})
                    
                    for col in df.columns:
                        if col == 'site_id': continue
                        target = detect_and_route(df[col])
                        col_name = f"{sheet}_{col}"
                        if target == 'numeric': curr_num[col_name] = pd.to_numeric(df[col], errors='coerce')
                        elif target == 'alphabet': curr_alpha[col_name] = df[col].astype(str)
                        elif target == 'alphanumeric': curr_alphanum[col_name] = df[col].astype(str)
                    
                    if curr_num.shape[1] > 1: buffer_num.append(curr_num)
                    if curr_alpha.shape[1] > 1: buffer_alpha.append(curr_alpha)
                    if curr_alphanum.shape[1] > 1: buffer_alphanum.append(curr_alphanum)

                # Aggregate
                all_sites = set()
                
                # Numeric
                if buffer_num:
                    df_num = pd.concat(buffer_num).groupby('site_id').mean().fillna(0)
                    all_sites.update(df_num.index.tolist())
                else: df_num = pd.DataFrame()

                # Alphabet
                if buffer_alpha:
                    df_alpha = pd.concat(buffer_alpha)
                    # Join text
                    df_alpha = df_alpha.groupby('site_id').agg(lambda x: ' '.join(x.astype(str)))
                    df_alpha = df_alpha.apply(lambda x: ' '.join(x), axis=1).to_frame('all_text')
                    all_sites.update(df_alpha.index.tolist())
                else: df_alpha = pd.DataFrame()

                # Alphanumeric
                if buffer_alphanum:
                    df_alphanum = pd.concat(buffer_alphanum).groupby('site_id').nunique()
                    all_sites.update(df_alphanum.index.tolist())
                else: df_alphanum = pd.DataFrame()

                sorted_sites = sorted(list(all_sites))
                
                # Prepare JSON Output
                numeric_list = []
                if not df_num.empty:
                    numeric_list = df_num.reindex(sorted_sites).fillna(0).values.tolist()
                
                alphabet_list = []
                if not df_alpha.empty:
                    alphabet_list = df_alpha.reindex(sorted_sites).fillna('').iloc[:, 0].tolist()
                
                alphanum_list = []
                if not df_alphanum.empty:
                    alphanum_list = df_alphanum.reindex(sorted_sites).fillna(0).values.tolist()

                # Convert to JS
                return js.Object.fromEntries(js.Map([
                    ("site_ids", js.Array.from_iter(sorted_sites)),
                    ("numeric", js.Array.from_iter([js.Array.from_iter(row) for row in numeric_list])),
                    ("alphabet", js.Array.from_iter(alphabet_list)),
                    ("alphanum", js.Array.from_iter([js.Array.from_iter(row) for row in alphanum_list]))
                ]))

            except Exception as e:
                return js.Object.fromEntries(js.Map([("error", str(e))]))

        js.window.process_excel_bridge = create_proxy(process_excel_py)
    </py-script>
</body>
</html>
