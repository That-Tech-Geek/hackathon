<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hAIlth - Command Center</title>
    
    <!-- 1. FIREBASE SDKs (Compat version for Realtime DB) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Note: Firestore SDK removed, Database SDK added -->
    
    <!-- 2. SHEETJS (Parses Excel in browser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- 3. FONT AWESOME (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #3b82f6; 
            --accent-glow: rgba(59, 130, 246, 0.5);
            --success: #10b981; 
            --bg: #f1f5f9; 
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-sub: #64748b;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--primary); 
            margin: 0; 
            padding: 40px 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
        }
        
        .container { 
            width: 100%; 
            max-width: 850px; 
            animation: fadeIn 0.5s ease-out;
        }

        /* HEADER */
        .header { text-align: center; margin-bottom: 40px; }
        h1 { font-weight: 800; font-size: 2.5rem; margin: 0; letter-spacing: -1px; color: var(--primary); }
        .subtitle { color: var(--text-sub); font-size: 1.1rem; margin-top: 5px; }
        .tag { background: #e0f2fe; color: #0284c7; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; vertical-align: middle; margin-left: 10px; }

        /* DROP ZONE */
        .drop-zone {
            border: 2px dashed #cbd5e1; 
            border-radius: 16px; 
            padding: 60px 20px; 
            text-align: center;
            background: var(--card-bg); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        .drop-zone:hover { 
            border-color: var(--accent); 
            transform: translateY(-2px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .drop-zone.active { 
            border-color: var(--success); 
            background: #f0fdf4; 
            transform: scale(1.02);
        }
        .icon-large { font-size: 3rem; color: #94a3b8; margin-bottom: 15px; transition: color 0.3s; }
        .drop-zone:hover .icon-large { color: var(--accent); }

        /* STATUS CARD */
        .status-card {
            margin-top: 25px; 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 25px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
            display: none; 
            border-left: 6px solid #cbd5e1;
            animation: slideUp 0.4s ease-out;
        }
        .status-card.processing { border-color: var(--accent); }
        .status-card.success { border-color: var(--success); }

        .status-header { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
        .status-title { font-weight: 700; font-size: 1.2rem; margin: 0; }
        .status-desc { color: var(--text-sub); margin: 0; font-size: 0.95rem; }

        /* SPINNER */
        .spinner { 
            display: inline-block; 
            width: 24px; 
            height: 24px; 
            border: 3px solid rgba(59, 130, 246, 0.3); 
            border-radius: 50%; 
            border-top-color: var(--accent); 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* AGENT RESPONSE BOX */
        .agent-box {
            margin-top: 25px; 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 30px;
            border-radius: 12px; 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap;
            display: none; 
            border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            position: relative;
            line-height: 1.6;
        }
        .agent-header { 
            color: var(--success); 
            font-weight: bold; 
            margin-bottom: 15px; 
            display: block; 
            border-bottom: 1px solid #334155; 
            padding-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        .agent-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* ANIMATIONS */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>hAIlth <span class="tag">AGENTIC V1.0</span></h1>
        <div class="subtitle">Triple-Stream Real-Time Analytics Dashboard</div>
    </div>

    <!-- UPLOAD SECTION -->
    <div class="drop-zone" id="dropZone">
        <i class="fas fa-cloud-upload-alt icon-large"></i>
        <h3 style="margin: 0; color: var(--text-main);">Drag & Drop Clinical Data Stream</h3>
        <p style="color: var(--text-sub); margin-top: 10px; font-size: 0.9em;">Supports .xlsx files with multiple tabs (Reference, Labs, Logs)</p>
    </div>

    <!-- LIVE STATUS SECTION -->
    <div class="status-card" id="statusCard">
        <div class="status-header">
            <div id="statusIcon"></div>
            <div>
                <h3 class="status-title" id="statusTitle">Processing...</h3>
                <p class="status-desc" id="statusDesc">Uploading data to secure cloud pipeline...</p>
            </div>
        </div>
    </div>

    <!-- THE AGENT RESPONSE (Hidden until AI runs) -->
    <div class="agent-box" id="agentResult">
        <span class="agent-header">>>> INCOMING SECURE TRANSMISSION // AGENT INTERVENTION PROTOCOL</span>
        <span class="agent-badge">LIVE</span>
        <div id="agentText"></div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCOrb15cWf-0j4q3EYmpgChVIANQh-Eok0", // <--- Still need this
        authDomain: "hackathons-8f113.firebaseapp.com",
        databaseURL: "https://hackathons-8f113-default-rtdb.firebaseio.com/", // <--- YOUR NEW URL
        projectId: "hackathons-8f113",
        storageBucket: "hackathons-8f113.firebasestorage.app",
        messagingSenderId: "682635562372",
        appId: "1:682635562372:web:e5cac66a90f5fce2a5e1d1"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    // SWITCH TO REALTIME DATABASE
    const db = firebase.database();

    // --- 2. DRAG & DROP LOGIC ---
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => { 
        e.preventDefault(); 
        dropZone.classList.add('active'); 
    });
    
    dropZone.addEventListener('dragleave', () => { 
        dropZone.classList.remove('active'); 
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file) {
            // Check file extension
            if(file.name.endsWith('.xlsx') || file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                alert("Invalid file type. Please upload .xlsx or .csv");
            }
        }
    });

    // --- 3. EXCEL PARSING & UPLOAD (REALTIME DB) ---
    async function processFile(file) {
        // UI Update: Processing
        const card = document.getElementById('statusCard');
        card.style.display = 'block';
        card.className = 'status-card processing';
        
        document.getElementById('statusIcon').innerHTML = '<span class="spinner"></span>';
        document.getElementById('statusTitle').innerText = 'Ingesting Data Stream...';
        document.getElementById('statusDesc').innerText = 'Parsing Excel sheets and synchronizing with Realtime DB...';
        
        // Hide previous results
        document.getElementById('agentResult').style.display = 'none';
        
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // Build the Payload
            let payload = {};
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                // Convert sheet to JSON
                payload[sheetName] = XLSX.utils.sheet_to_json(worksheet);
            });

            // Upload to REALTIME DATABASE (db.ref instead of collection)
            try {
                const streamRef = db.ref('clinical_streams').push();
                
                await streamRef.set({
                    meta_filename: file.name,
                    upload_timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: "PENDING_REVIEW", // This triggers the Python Agent
                    data_payload: payload
                });

                console.log("Data pushed with Key: ", streamRef.key);
                
                // Update UI: Waiting for AI
                document.getElementById('statusTitle').innerText = 'AI Agent Active';
                document.getElementById('statusDesc').innerText = 'Triple-Stream Analysis in progress. Waiting for intervention...';
                
                // START LISTENING FOR RESPONSE (REALTIME DB)
                listenForAgent(streamRef.key);

            } catch (error) {
                console.error("Error pushing data: ", error);
                document.getElementById('statusCard').className = 'status-card';
                document.getElementById('statusTitle').innerText = 'Upload Failed';
                document.getElementById('statusDesc').innerText = 'Check console for permission/config errors.';
                document.getElementById('statusIcon').innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444; font-size: 24px;"></i>';
            }
        };
        
        reader.readAsArrayBuffer(file);
    }

    // --- 4. REAL-TIME LISTENER (REALTIME DB) ---
    function listenForAgent(streamKey) {
        const streamRef = db.ref('clinical_streams/' + streamKey);
        
        // Use 'value' listener for Realtime DB
        const listener = streamRef.on('value', (snapshot) => {
            const data = snapshot.val();
            
            // Check if status changed to PROCESSED
            if (data && data.status === "PROCESSED" && data.agent_analysis) {
                
                // UI Success State
                document.getElementById('statusCard').className = 'status-card success';
                document.getElementById('statusIcon').innerHTML = '<i class="fas fa-check-circle" style="color: #10b981; font-size: 24px;"></i>';
                document.getElementById('statusTitle').innerText = 'Analysis Complete';
                document.getElementById('statusDesc').innerText = 'Intervention Protocol Generated.';
                
                // Show the Email
                const agentBox = document.getElementById('agentResult');
                agentBox.style.display = 'block';
                agentBox.style.animation = 'fadeIn 1s';
                
                // Typewriter Effect
                const text = data.agent_analysis.generated_email;
                const textContainer = document.getElementById('agentText');
                textContainer.innerHTML = ''; // Clear previous
                
                let i = 0;
                function typeWriter() {
                    if (i < text.length) {
                        textContainer.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(typeWriter, 5);
                    }
                }
                typeWriter();
                
                // Detach listener
                streamRef.off('value', listener);
            }
        });
    }
</script>

</body>
</html>
