<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trial Agent (Serverless)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PyScript: The Engine -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* Custom Loader Animation */
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Hide scrollbar for cleaner look */
        body::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <!-- CONFIGURATION: Dependencies -->
    <py-config>
        packages = ["pandas", "scikit-learn", "joblib", "openpyxl", "numpy"]
    </py-config>

    <!-- UI LAYER -->
    <div class="max-w-4xl w-full space-y-8 animate-fade-in">
        <div class="text-center">
            <h1 class="text-5xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">
                Clinical Agent <span class="text-white text-2xl font-light">v2.0</span>
            </h1>
            <p class="mt-3 text-slate-400 text-lg">Serverless Triple-Stream Analysis Engine</p>
        </div>

        <!-- STATUS BOX -->
        <div id="status-box" class="bg-slate-800/50 backdrop-blur p-4 rounded-lg border border-slate-700 text-center transition-all duration-300">
            <div id="loading-spinner" class="inline-block w-4 h-4 border-2 border-yellow-400 border-t-transparent rounded-full animate-spin mr-2"></div>
            <span id="loading-text" class="text-yellow-400 font-mono text-sm">Initializing Python Runtime...</span>
        </div>

        <!-- UPLOAD SECTION -->
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-700 shadow-2xl relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-blue-500 group-hover:bg-blue-400 transition-colors"></div>
            
            <label class="block mb-4 text-sm font-medium text-slate-300 uppercase tracking-wider">Upload Clinical Dataset (.xlsx)</label>
            <input type="file" id="file-upload" class="block w-full text-sm text-slate-400 
                file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 
                file:text-sm file:font-semibold file:bg-blue-600 file:text-white 
                hover:file:bg-blue-500 file:cursor-pointer cursor-pointer transition-all" 
                accept=".xlsx" disabled>
            
            <button id="analyze-btn" class="mt-8 w-full bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-4 px-6 rounded-lg transition-all shadow-lg opacity-50 cursor-not-allowed transform active:scale-95" disabled>
                INITIATE ANALYSIS PROTOCOL
            </button>
        </div>

        <!-- RESULTS DASHBOARD (Hidden by default) -->
        <div id="results-area" class="hidden space-y-6 transition-all duration-500 ease-in-out">
            <!-- Score Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-blue-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Operational (Numeric)</h3>
                    <p id="res-num" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">Cycle time & variance metrics</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-purple-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Documentation (Text)</h3>
                    <p id="res-alpha" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">NLP semantic analysis</p>
                </div>
                <div class="bg-slate-800 p-6 rounded-lg border-l-4 border-orange-500 shadow-lg">
                    <h3 class="text-slate-400 text-xs uppercase tracking-widest mb-1">Integrity (IDs)</h3>
                    <p id="res-alphanum" class="text-3xl font-mono font-bold text-white">--</p>
                    <p class="text-xs text-slate-500 mt-2">Pattern matching & complexity</p>
                </div>
            </div>
            
            <!-- Intervention Protocol -->
            <div class="bg-slate-900 border border-slate-700 rounded-lg shadow-xl overflow-hidden">
                <div class="bg-slate-800 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-emerald-400">Intervention Protocol Generated</h3>
                    <span class="text-xs bg-emerald-900 text-emerald-300 px-2 py-1 rounded">PRIORITY HIGH</span>
                </div>
                <div class="p-6">
                    <pre id="intervention-text" class="text-sm text-slate-300 font-mono whitespace-pre-wrap leading-relaxed"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- PYTHON LOGIC LAYER -->
    <py-script>
        import js
        import pandas as pd
        import numpy as np
        import joblib
        import io
        import warnings
        import asyncio
        from pyodide.http import pyfetch
        from pyodide.ffi import create_proxy
        from js import document, console, Uint8Array, File, FileReader

        warnings.filterwarnings('ignore')

        # --- GLOBAL STATE ---
        MODELS = {}

        # --- 1. MODEL LOADER ---
        async def load_models():
            """Fetch .joblib files from the local server into PyScript virtual FS"""
            files = [
                "numeric_model.joblib", "numeric_scaler.joblib",
                "alphabet_model.joblib", "alphabet_tfidf.joblib",
                "alphanum_model.joblib", "alphanum_scaler.joblib"
            ]
            
            status_text = document.getElementById('loading-text')
            
            for filename in files:
                try:
                    # Fetch file from server
                    response = await pyfetch(filename)
                    if response.status == 200:
                        content = await response.bytes()
                        # Write to virtual filesystem
                        with open(filename, "wb") as f:
                            f.write(content)
                        console.log(f"Loaded {filename}")
                    else:
                        console.error(f"Failed to fetch {filename}")
                        status_text.innerText = f"Error: Missing {filename}"
                        status_text.className = "text-red-400 font-mono"
                        return
                except Exception as e:
                    console.error(f"Error loading {filename}: {str(e)}")
                    status_text.innerText = f"Error loading models. Check console."
                    status_text.className = "text-red-400 font-mono"
                    return

            # Load into Memory
            try:
                status_text.innerText = " hydrating models..."
                MODELS['num_model'] = joblib.load('numeric_model.joblib')
                MODELS['num_scaler'] = joblib.load('numeric_scaler.joblib')
                MODELS['alpha_model'] = joblib.load('alphabet_model.joblib')
                MODELS['alpha_tfidf'] = joblib.load('alphabet_tfidf.joblib')
                MODELS['alphanum_model'] = joblib.load('alphanum_model.joblib')
                MODELS['alphanum_scaler'] = joblib.load('alphanum_scaler.joblib')
                
                # Update UI to Ready State
                status_text.innerText = "System Ready. Waiting for Data.";
                status_text.className = "text-emerald-400 font-mono font-bold";
                document.getElementById('loading-spinner').classList.remove('animate-spin');
                document.getElementById('loading-spinner').classList.add('bg-emerald-400');
                
                # Enable Controls
                document.getElementById('file-upload').disabled = False
                btn = document.getElementById('analyze-btn')
                btn.disabled = False
                btn.classList.remove('opacity-50', 'cursor-not-allowed')
                
            except Exception as e:
                status_text.innerText = f"Init Error: {str(e)}"
                console.error(str(e))

        # --- 2. DATA LOGIC ---
        def detect_and_route(series):
            clean = series.dropna().astype(str)
            if clean.empty: return 'skip'
            try:
                pd.to_numeric(clean)
                return 'numeric'
            except:
                pass
            if clean.str.match(r'^[a-zA-Z\s\.,]+$').all():
                return 'alphabet'
            return 'alphanumeric'

        async def run_analysis(event):
            """Main Event Handler triggered by Button Click"""
            
            # 1. UI Feedback
            btn = document.getElementById('analyze-btn')
            btn.innerText = "PROCESSING STREAMS..."
            btn.disabled = True
            
            file_input = document.getElementById('file-upload')
            file_list = file_input.files
            if file_list.length == 0:
                btn.innerText = "NO FILE SELECTED"
                await asyncio.sleep(2)
                btn.innerText = "INITIATE ANALYSIS PROTOCOL"
                btn.disabled = False
                return

            file_obj = file_list.item(0)
            
            try:
                # 2. Read File (Async)
                array_buf = await file_obj.arrayBuffer()
                file_bytes = array_buf.to_bytes()
                
                # 3. Process Excel
                xls = pd.ExcelFile(io.BytesIO(file_bytes))
                
                buffer_num, buffer_alpha, buffer_alphanum = [], [], []
                
                for sheet in xls.sheet_names:
                    if 'ref' in sheet.lower() or 'dict' in sheet.lower(): continue
                    df = pd.read_excel(xls, sheet_name=sheet)
                    if df.empty: continue
                    
                    df.columns = [str(c).lower().strip().replace(' ', '_') for c in df.columns]
                    site_col = next((c for c in df.columns if 'site' in c and 'id' in c), None)
                    if not site_col: continue
                    df.rename(columns={site_col: 'site_id'}, inplace=True)
                    
                    curr_num = pd.DataFrame({'site_id': df['site_id']})
                    curr_alpha = pd.DataFrame({'site_id': df['site_id']})
                    curr_alphanum = pd.DataFrame({'site_id': df['site_id']})
                    
                    for col in df.columns:
                        if col == 'site_id': continue
                        target = detect_and_route(df[col])
                        col_name = f"{sheet}_{col}"
                        if target == 'numeric': curr_num[col_name] = pd.to_numeric(df[col], errors='coerce')
                        elif target == 'alphabet': curr_alpha[col_name] = df[col].astype(str)
                        elif target == 'alphanumeric': curr_alphanum[col_name] = df[col].astype(str)
                    
                    if curr_num.shape[1] > 1: buffer_num.append(curr_num)
                    if curr_alpha.shape[1] > 1: buffer_alpha.append(curr_alpha)
                    if curr_alphanum.shape[1] > 1: buffer_alphanum.append(curr_alphanum)

                # 4. Aggregation
                streams = {}
                if buffer_num: streams['numeric'] = pd.concat(buffer_num).groupby('site_id').mean().fillna(0)
                else: streams['numeric'] = pd.DataFrame()
                
                if buffer_alpha:
                    raw_alpha = pd.concat(buffer_alpha)
                    streams['alphabet'] = raw_alpha.groupby('site_id').agg(lambda x: ' '.join(x.astype(str)))
                    streams['alphabet'] = streams['alphabet'].apply(lambda x: ' '.join(x), axis=1).to_frame('all_text')
                else: streams['alphabet'] = pd.DataFrame()

                if buffer_alphanum: streams['alphanumeric'] = pd.concat(buffer_alphanum).groupby('site_id').nunique()
                else: streams['alphanumeric'] = pd.DataFrame()

                # 5. Inference
                all_sites = set()
                for k,v in streams.items(): 
                    if not v.empty: all_sites.update(v.index.tolist())
                
                if not all_sites: 
                    raise Exception("No valid site ID columns found in data.")

                results = pd.DataFrame(index=list(all_sites))
                
                # Numeric Model
                if not streams['numeric'].empty:
                    data = streams['numeric'].reindex(results.index).fillna(0)
                    results['numeric_score'] = MODELS['num_model'].decision_function(MODELS['num_scaler'].transform(data))
                else: results['numeric_score'] = 0.0

                # Alphabet Model
                if not streams['alphabet'].empty:
                    data = streams['alphabet'].reindex(results.index).fillna('')
                    results['alphabet_score'] = MODELS['alpha_model'].decision_function(MODELS['alpha_tfidf'].transform(data['all_text']).toarray())
                else: results['alphabet_score'] = 0.0

                # Alphanumeric Model
                if not streams['alphanumeric'].empty:
                    data = streams['alphanumeric'].reindex(results.index).fillna(0)
                    results['alphanum_score'] = MODELS['alphanum_model'].decision_function(MODELS['alphanum_scaler'].transform(data))
                else: results['alphanum_score'] = 0.0

                results['global_risk'] = results.mean(axis=1)
                
                # 6. Diagnosis & Report
                worst_site = results.sort_values('global_risk').iloc[0]
                site_id = worst_site.name
                
                # Update Score Cards
                document.getElementById('res-num').innerText = f"{worst_site['numeric_score']:.4f}"
                document.getElementById('res-alpha').innerText = f"{worst_site['alphabet_score']:.4f}"
                document.getElementById('res-alphanum').innerText = f"{worst_site['alphanum_score']:.4f}"
                
                # Generate Email Logic
                failures = []
                if worst_site['numeric_score'] < -0.1: failures.append("NUMERIC (Operational Efficiency)")
                if worst_site['alphabet_score'] < -0.1: failures.append("ALPHABET (Documentation Quality)")
                if worst_site['alphanum_score'] < -0.1: failures.append("ALPHANUMERIC (Data Integrity)")
                
                diagnosis = " & ".join(failures) if failures else "General Anomaly"
                
                email_body = f"""TO: Site Coordinator (ID: {site_id})
FROM: Clinical AI Operations Agent
SUBJECT: URGENT - Risk Anomaly Detected [{diagnosis}]

Body:
System monitoring has flagged Site {site_id} as a critical operational bottleneck.

Our Triple-Stream Analysis detected the following anomalies:
- Diagnosis: {diagnosis}
- Risk Score: {worst_site['global_risk']:.4f} (Threshold: -0.10)

CONTEXT AWARE RECOMMENDATION:
"""
                if "NUMERIC" in diagnosis:
                    email_body += "- The statistical variance in your operational logs is too high. Please audit data entry cycle times.\n"
                if "ALPHABET" in diagnosis:
                    email_body += "- Semantic analysis of your clinical notes indicates a lack of detail or high frequency of error keywords.\n"
                if "ALPHANUMERIC" in diagnosis:
                    email_body += "- Irregular patterns found in Subject IDs or Protocol Codes. Verify alignment with the Reference Dictionary.\n"
                    
                email_body += "\nPlease acknowledge receipt of this automated intervention."
                
                document.getElementById('intervention-text').innerText = email_body
                
                # Show Results Area
                document.getElementById('results-area').classList.remove('hidden')
                
                # Reset Button
                btn.innerText = "RUN ANALYSIS AGAIN"
                btn.disabled = False
                
            except Exception as e:
                console.error(f"Analysis Error: {e}")
                btn.innerText = "ERROR - CHECK CONSOLE"
                btn.classList.add('bg-red-600')
                await asyncio.sleep(3)
                btn.innerText = "INITIATE ANALYSIS PROTOCOL"
                btn.disabled = False
                btn.classList.remove('bg-red-600')

        # --- 3. INIT & BINDINGS ---
        
        # Bind the Python function to the Button Click
        analysis_proxy = create_proxy(run_analysis)
        document.getElementById("analyze-btn").addEventListener("click", analysis_proxy)
        
        # Start Loading
        asyncio.ensure_future(load_models())
    </py-script>
</body>
</html>
